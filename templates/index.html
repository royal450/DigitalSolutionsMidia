<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF to Audio Converter</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #121212;
            color: white;
            text-align: center;
        }
        .container {
            margin-top: 50px;
        }
        #progress-container {
            display: none;
            margin-top: 20px;
        }
        #play-btn, #download-btn {
            display: none;
            margin-top: 20px;
        }
        #text-box {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            text-align: left;
        }
        .highlight {
            background-color: yellow;
            color: black;
        }
    </style>
</head>
<body>

    <div class="container">
        <h2 class="text-3xl font-bold">PDF to Audio Converter</h2>
        
        <input type="file" id="file-upload" class="mt-4">
        <button class="btn btn-primary mt-3" onclick="uploadFile()">Upload</button>
        
        <div id="progress-container">
            <div class="progress">
                <div id="progress-bar" class="determinate" style="width: 0%"></div>
            </div>
            <p id="status-text">Waiting for upload...</p>
        </div>
        
        <button id="play-btn" class="btn btn-success" onclick="toggleAudio()">▶ Play</button>
        <button id="download-btn" class="btn btn-warning" onclick="downloadAudio()">⬇ Download</button>

        <div id="text-box">
            <h4>Extracted Text</h4>
            <p id="extracted-text"></p>
        </div>
    </div>

    <script>
        let audio = new Audio();
        let words = [];
        let index = 0;
        let playing = false;

        function uploadFile() {
            let file = document.getElementById("file-upload").files[0];
            if (!file) {
                alert("Please select a file!");
                return;
            }
            
            let formData = new FormData();
            formData.append("file", file);
            
            document.getElementById("progress-container").style.display = "block";
            updateProgress("Uploading...", 5);

            fetch("/upload", {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    words = data.extracted_text.split(" ");
                    document.getElementById("extracted-text").innerHTML = words.map(w => `<span>${w}</span>`).join(" ");
                    document.getElementById("text-box").style.display = "block";
                    
                    audio.src = "/output/audio.mp3";
                    document.getElementById("play-btn").style.display = "inline-block";
                    document.getElementById("download-btn").style.display = "inline-block";

                    updateProgress("Conversion Complete!", 100);
                }
            })
            .catch(error => console.error("Error:", error));
        }

        function updateProgress(status, percent) {
            document.getElementById("status-text").innerText = status;
            document.getElementById("progress-bar").style.width = percent + "%";
        }

        function toggleAudio() {
            if (!playing) {
                audio.play();
                document.getElementById("play-btn").innerText = "⏸ Pause";
                playing = true;
                highlightWords();
            } else {
                audio.pause();
                document.getElementById("play-btn").innerText = "▶ Play";
                playing = false;
            }
        }

        function highlightWords() {
            let spans = document.getElementById("extracted-text").getElementsByTagName("span");
            let interval = setInterval(() => {
                if (!playing || index >= words.length) {
                    clearInterval(interval);
                    index = 0;
                    return;
                }
                if (index > 0) spans[index - 1].classList.remove("highlight");
                spans[index].classList.add("highlight");
                index++;
            }, 500);
        }

        function downloadAudio() {
            window.location.href = "/output/audio.mp3";
        }
    </script>

</body>
</html>
